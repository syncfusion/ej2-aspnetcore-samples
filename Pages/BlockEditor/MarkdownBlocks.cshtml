@page
@model EJ2CoreSampleBrowser_NET9.Pages.BlockEditor.MarkdownBlocksModel
@using Syncfusion.EJ2
@using Syncfusion.EJ2.Navigations

@section ControlsSection {
    <div class="control-section blockeditor-marked">
        <!-- Sidebar: TOC / TreeView -->
        <ejs-sidebar id="sidebar-treeview"
                     class="sidebar-content"
                     enableDock="true"
                     width="220px"
                     enableGestures="false"
                     dockSize="33px"
                     open="onOpen"
                     close="onClose"
                     mediaQuery="(min-width: 600px)"
                     target=".blockeditor-marked"
                     isOpen="false">
            <e-content-template>
                <div class="sidebar-header">
                    <span>@Model.SidebarHeaderText</span>
                </div>

                <div class="sb-rightpane-collapsed">
                    <div class="labelchoose">Markdown Templates</div>
                </div>

                <div class="main-menu">
                    <ejs-button id="left-toc-closebtn"
                                cssClass="e-btn e-round closebutton" iconCss="e-icons e-chevron-left"
                                onclick="openClick()">
                    </ejs-button>

                    <ejs-treeview id="main-treeview"
                                  expandOn="Click"
                                  nodeSelected="onNodeSelected"
                                  fields='@(
                 new TreeViewFieldsSettings {
                    DataSource = Model.TreeData,
                    Id = "id",
                    Text = "name",
                    Child = "children"
                 }
              )'>
                    </ejs-treeview>
                </div>
            </e-content-template>
        </ejs-sidebar>

        <!-- Content -->
        <div id="content_container" class="block-content">
            <div class="stick">
                <ejs-toolbar id="mk-toolbar">
                    <e-toolbar-items>
                        <e-toolbar-item type="Separator"></e-toolbar-item>
                        <e-toolbar-item align="Left">
                            <e-content-template #template>
                                <div class="breadcrumbcontent">
                                    <ejs-breadcrumb id="mk-breadcrumb" items="@Model.BreadcrumbItems">
                                        <e-breadcrumb-items>
                                            <span class='e-icons e-chevron-right'></span>
                                        </e-breadcrumb-items>
                                    </ejs-breadcrumb>
                                </div>
                            </e-content-template>
                        </e-toolbar-item>
                        <e-toolbar-item align="Right">
                            <e-content-template #template>
                                <ejs-button id="download" class="e-btn" iconCss="e-icons e-download" cssClass="downloadbutton" title="Download Markdown" onclick="downloadMarkdown()"></ejs-button>
                            </e-content-template>
                        </e-toolbar-item>
                    </e-toolbar-items>
                </ejs-toolbar>
            </div>

            <div class="markeditor">
                <ejs-blockeditor id="mk-blockeditor" height="602px" created="createdblock">
                    <e-blockeditor-inlinetoolbarsettings enable="true" items="@Model.InlineToolbarItems">
                    </e-blockeditor-inlinetoolbarsettings>
                    <e-blockeditor-commandmenusettings popupWidth="298px" popupHeight="400px" commands="@Model.CommandMenuItems"></e-blockeditor-commandmenusettings>

                </ejs-blockeditor>
            </div>
        </div>
    </div>
}

@section PreScripts {
    <!-- Markdown dependencies via cdnjs (CSP-friendly). Remove integrity if you don’t have the exact SRI. -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/marked/12.0.2/marked.min.js"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/turndown/7.1.2/turndown.min.js"
            crossorigin="anonymous" referrerpolicy="no-referrer"></script>

    <script>
        // Page data from server
        const TREE_DATA = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.TreeData));
        const INITIAL_LOAD_PATH = '@Model.InitialMdPath'.replace(/&amp;/g, '&');

        // Cache DOM refs
        const sidebarId = 'sidebar-treeview';
        const treeId = 'main-treeview';
        const editorId = 'mk-blockeditor';
        const breadcrumbId = 'mk-breadcrumb';
        const closeBtnId = 'left-toc-closebtn';

        let turndownService;

        function getSidebar() {
          return ej.base.getComponent(document.getElementById(sidebarId), 'sidebar');
        }
        function getTree() {
          return ej.base.getComponent(document.getElementById(treeId), 'treeview');
        }
        function getEditor() {
          return ej.base.getInstance(document.getElementById(editorId), ejs.blockeditor.BlockEditor);
        }
        function getBreadcrumb() {
          return ej.base.getComponent(document.getElementById(breadcrumbId), 'breadcrumb');
        }
        function setBreadcrumb(items) {
          const bc = getBreadcrumb();
          if (!bc) return;
          bc.items = items || [];
          bc.dataBind();
        }

        // Lifecycle
        function createdblock() {
          turndownService = new TurndownService();
          setTimeout(() => {
            if (INITIAL_LOAD_PATH) {
              loadContent(INITIAL_LOAD_PATH);
              setBreadcrumb([{ text: 'Team' }, { text: 'Team Sessions' }]);
            }
          }, 100);
        }

        // Sidebar open/close
        function onOpen() {
          const closeBtn = document.getElementById(closeBtnId);
          const tv = getTree();
          if (tv) {
            tv.expandAll();
            tv.element.style.display = 'block';
          }
          if (closeBtn) {
            closeBtn.style.left = '202px';
            closeBtn.classList.remove('expand-mode');
          }
        }
        function onClose() {
          const closeBtn = document.getElementById(closeBtnId);
          const tv = getTree();
          if (tv) {
            tv.element.style.display = 'none';
          }
          if (closeBtn) {
            closeBtn.style.left = '18px';
            closeBtn.classList.add('expand-mode');
          }
        }
        function openClick() {
          const sb = getSidebar();
          if (sb) sb.toggle();
        }

        // Helpers
        function formatBreadcrumbText(name) {
          if (!name) return '';
          return name.endsWith('.md') ? name.replace(/\.md$/i, '') : name;
        }

        // Load Markdown, convert to HTML via marked, then to blocks via parseHtmlToBlocks
        async function loadContent(mdFile) {
          try {
            // Encode URI to support spaces/special chars in file names
            const url = encodeURI(mdFile);
            const res = await fetch(url, { cache: 'no-cache' });
            if (!res.ok) throw new Error('HTTP ' + res.status);
            const md = await res.text();

            const html = window.marked.parse(md);
            const editor = getEditor();
            if (!editor) return;

            try {
              const nodeDatas = editor.parseHtmlToBlocks(html);
              editor.renderBlocksFromJson(nodeDatas, true);
            } catch (parseErr) {
              renderFallbackBlocks(`Parsed content from ${mdFile} failed.`);
            }
          } catch (err) {
            renderFallbackBlocks(`Error loading ${mdFile}. Ensure file exists under /wwwroot/blockeditor/mdfiles.`);
          }
        }

        function renderFallbackBlocks(message) {
          const editor = getEditor();
          if (!editor) return;
          const blocks = [{
            id: 'fallback-block',
            type: 'Paragraph',
            content: [{ id: 'fallback-t', type: 'Text', content: message }],
            props: { placeholder: 'Fallback content' },
            indent: 0
          }];
          editor.renderBlocksFromJson(blocks, true);
        }

        // TreeView selection
        function onNodeSelected(args) {
          const node = args.nodeData;
          if (!node) return;
          const id = node.id;

          if (id === 'Team Sessions') {
            setBreadcrumb([{ text: 'Team' }, { text: 'Team Sessions' }]);
            loadContent('@Model.TeamSessionsMdPath');
            return;
          }

          // Find node data in TREE_DATA
          function findNodeById(arr, nid) {
            for (const n of arr) {
              if (n.id === nid) return n;
              if (n.children && n.children.length) {
                const f = findNodeById(n.children, nid);
                if (f) return f;
              }
            }
            return null;
          }
          const selectedNode = findNodeById(TREE_DATA, id);

          if (selectedNode && selectedNode.mdFile) {
            loadContent(selectedNode.mdFile);
            const parentId = node.parentID;
            const bc = parentId === 'Team Sessions'
              ? [{ text: 'Team' }, { text: 'Team Sessions' }, { text: formatBreadcrumbText(selectedNode.name) }]
              : [{ text: 'Team' }, { text: formatBreadcrumbText(selectedNode.name) }];
            setBreadcrumb(bc);
          }
        }

        // Download current content as Markdown
        function downloadMarkdown() {
          const editor = getEditor();
          if (!editor || !window.TurndownService || !turndownService) {
            return;
          }
          let html = '';
          try {
            html = editor.getDataAsHtml();
          } catch (e) {
            return;
          }
          const md = turndownService.turndown(html || '');

          const bc = getBreadcrumb();
          let name = 'document';
          if (bc && bc.items && bc.items.length) {
            const last = bc.items[bc.items.length - 1].text || 'document';
            name = (last + '').replace(/[\\/:*?"<>|]+/g, '').trim() || 'document';
          }
          const fileName = name + '.md';
          const blob = new Blob([md], { type: 'text/markdown;charset=utf-8' });
          const url = URL.createObjectURL(blob);
          const a = document.createElement('a');
          try {
            a.href = url;
            a.download = fileName;
            document.body.appendChild(a);
            a.click();
          } finally {
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
          }
        }
    </script>
}

<style>
    .blockeditor-marked .sidebar-content {
        overflow: visible;
        margin-top: 20px;
        border: 1px solid #dee2e6;
        height: 95%;
    }

    .blockeditor-marked {
        height: 680px;
        overflow: hidden;
    }

        .blockeditor-marked .block-content {
            border: 1px solid #dee2e6;
            border-left: none;
        }

        .blockeditor-marked .main-menu .e-list-parent.e-ul {
            overflow: hidden;
        }

        .blockeditor-marked .block-content .downloadbutton {
            box-shadow: none;
            margin-right: 10px;
        }

        .blockeditor-marked .e-sidebar.e-left.e-transition.e-close {
            transition: transform 2.5s ease, visibility 1200ms;
        }

        .blockeditor-marked .sidebar-content .main-menu .closebutton {
            position: fixed;
            width: 30px;
            height: 30px;
            border-radius: 100%;
            z-index: 9;
            display: flex;
            align-items: center;
            top: 28px;
            cursor: pointer;
        }

        .blockeditor-marked .sidebar-content .main-menu #main-treeview {
            border: none;
        }

        .blockeditor-marked .sb-rightpane-collapsed {
            width: 33px;
            height: 200px;
            position: absolute;
            z-index: 1001;
            pointer-events: none;
        }

            .blockeditor-marked .sb-rightpane-collapsed .labelchoose {
                transform: translate(-50%,-50%) rotate(-90deg);
                margin-top: 190px;
                margin-left: 16px;
                white-space: nowrap;
                font-size: 14px;
                pointer-events: none;
            }

        .blockeditor-marked .sidebar-content .main-menu .closebutton.expand-mode {
            transform: rotate(180deg);
        }

        .blockeditor-marked .block-content .e-breadcrumb {
            pointer-events: none;
        }

        .blockeditor-marked .block-content .stick {
            position: sticky;
            top: 0;
            z-index: 10;
        }

        .blockeditor-marked .stick .block-content .e-chevron-right {
            font-size: 10px;
        }

        .blockeditor-marked .e-content-animation {
            transition: none;
            transform: none;
        }

        .blockeditor-marked .sidebar-content .sidebar-header {
            background-color: #f8f9fa;
            padding: 12px 16px;
            border-bottom: 1px solid #dee2e6;
            z-index: 8;
            font-size: 14px;
            font-weight: 600;
            color: #495057;
            user-select: none;
            height: 44px;
            display: flex;
            align-items: center;
        }

        body[class*="dark"] .blockeditor-marked .sidebar-content .sidebar-header,
        body[class*="high"] .blockeditor-marked .sidebar-content .sidebar-header {
          background-color: unset;
          color: unset;
        }

        .blockeditor-marked .sidebar-content .sidebar-header span {
            pointer-events: none;
        }

        .blockeditor-marked #sidebar-treeview.e-dock.e-close .sidebar-header {
            display: none;
        }

        .blockeditor-marked #sidebar-treeview:not(.e-close) .labelchoose {
            display: none;
        }

        .tailwind3-dark .blockeditor-marked .sidebar-content #left-toc-closebtn {
          background: rgb(73 76 80);
        }
        
        #mk-toolbar{
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding-left: 10px
        }
</style>

@section Meta {
    <meta name="description" content="This example demonstrates the Use Cases in ASP.NET Core Block Editor control. Explore here for more details." />
}

@section ActionDescription {
    <div id="action-description">
        <p>
            This sample demonstrates the Markdown templates viewer built with Block Editor,
            complete with a sidebar navigation tree, breadcrumb, and Markdown loading, editing and Download as Markdown
            capabilities.
        </p>
    </div>
}

@section Description {
    <div id="description">
        <p>
            The Block Editor Documentation Preview is a powerful, interactive
            documentation system that combines
            <code>BlockEditor</code> with a collapsible sidebar, tree
            navigation, and Markdown rendering.
            It allows users to view, edit, and download documentation articles
            written in Markdown format.
        </p>
        <p>Key features demonstrated in this sample:</p>
        <ul>
            <li>
                <strong>Sidebar with TreeView Navigation</strong>: Hierarchical menu
                using <code>ejs-treeview</code> to browse documentation sections.
            </li>
            <li>
                <strong>Markdown Loading</strong>: Loads <code>.md</code> files
                from the <code>assets</code> folder via <code>fetch</code>.
            </li>
            <li>
                <strong>Markdown to BlockEditor Conversion</strong>: Uses
                <code>MarkdownConverter</code> and <code>parseHtmlToBlocks()</code> to convert
                Markdown to rich editable blocks.
            </li>
            <li>
                <strong>Download as Markdown</strong>: Export current editor content
                back to clean Markdown using <code>TurndownService</code>.
            </li>
            <li>
                <strong>Dockable & Responsive Sidebar</strong>: Collapsible sidebar with
                smooth open/close animation and mobile-friendly behavior.
            </li>
            <li>
                <strong>Real-time Editing</strong>: Full Block Editor experience —
                formatting, lists, code blocks, mentions, slash commands, and more.
            </li>
            <li>
                <strong>Clean UI with Toolbar</strong>: Professional layout with
                breadcrumb and download button using Toolbar and Breadcrumb
                components.
            </li>
        </ul>
        <p>
            This sample serves as a complete template for building internal
            documentation portals, knowledge bases,
            technical wikis, or product guides using the Block
            Editor.
        </p>
    </div>
}